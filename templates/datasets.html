{% extends "layout.html" %}

{% block title %}数据集管理 - 垃圾短信过滤系统{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="text-center mb-4"><i class="fas fa-database me-2"></i>数据集管理</h1>
            <p class="lead text-center">上传、管理和使用数据集</p>
        </div>
    </div>

    <!-- 上传新数据集 -->
    <div class="row mb-5">
        <div class="col-lg-8 mx-auto">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-upload me-2"></i>上传新数据集</h5>
                </div>
                <div class="card-body">
                    <form id="dataset-upload-form" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="dataset-name" class="form-label">数据集名称</label>
                            <input type="text" class="form-control" id="dataset-name" name="name" placeholder="数据集名称">
                        </div>
                        <div class="mb-3">
                            <label for="dataset-description" class="form-label">描述</label>
                            <textarea class="form-control" id="dataset-description" name="description" rows="2" placeholder="数据集描述（可选）"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="dataset-file" class="form-label">CSV文件</label>
                            <input type="file" class="form-control" id="dataset-file" name="file" accept=".csv">
                            <div class="form-text">支持CSV格式，文件需包含文本列和标签列（可选）</div>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary" id="upload-dataset-btn">
                                <i class="fas fa-upload me-2"></i>上传数据集
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 数据集列表 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>已上传数据集</h5>
                    <button class="btn btn-sm btn-outline-light" id="refresh-datasets-btn">
                        <i class="fas fa-sync-alt me-1"></i>刷新
                    </button>
                </div>
                <div class="card-body">
                    <div id="datasets-loading" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <p class="mt-2">加载数据集列表...</p>
                    </div>
                    <div id="datasets-list" class="d-none">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>名称</th>
                                        <th>文件</th>
                                        <th>描述</th>
                                        <th>记录数</th>
                                        <th>垃圾短信</th>
                                        <th>正常短信</th>
                                        <th>上传时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="datasets-table-body">
                                    <!-- 数据集列表将通过JS填充 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div id="no-datasets" class="alert alert-info text-center d-none">
                        <i class="fas fa-info-circle me-2"></i>暂无上传的数据集，请上传新数据集
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 数据集使用模态框 -->
<div class="modal fade" id="use-dataset-modal" tabindex="-1" aria-labelledby="useDatasetModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="useDatasetModalLabel">使用数据集</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                <form id="use-dataset-form">
                    <input type="hidden" id="use-dataset-id" name="dataset_id">
                    <div class="mb-3">
                        <label for="use-action" class="form-label">操作</label>
                        <select class="form-select" id="use-action" name="action" required>
                            <option value="train">训练模型</option>
                            <option value="predict">批量预测</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="use-model-type" class="form-label">模型类型</label>
                        <select class="form-select" id="use-model-type" name="model_type" required>
                            <option value="" disabled selected>-- 请选择模型类型 --</option>
                            <option value="roberta">RoBERTa</option>
                            <option value="bert">BERT</option>
                            <option value="lstm">LSTM</option>
                            <option value="cnn">CNN</option>
                            <option value="xlnet">XLNet</option>
                            <option value="gpt">GPT</option>
                            <option value="attention_lstm">Attention LSTM</option>
                            <option value="svm">SVM</option>
                            <option value="naive_bayes">朴素贝叶斯</option>
                            <option value="ensemble">集成模型</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirm-use-dataset-btn">确认</button>
            </div>
        </div>
    </div>
</div>

<!-- 删除确认模态框 -->
<div class="modal fade" id="delete-dataset-modal" tabindex="-1" aria-labelledby="deleteDatasetModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteDatasetModalLabel">删除数据集</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                <p>确定要删除这个数据集吗？此操作不可撤销。</p>
                <p><strong>数据集：</strong><span id="delete-dataset-name"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-dataset-btn">删除</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 全局变量和工具函数
    let loadingDatasets = false;
    let lastDatasetLoad = 0;
    
    // 页面加载时获取数据集列表
    document.addEventListener('DOMContentLoaded', function() {
        // 初始化全局AppState对象（如果不存在）
        if (!window.AppState && typeof AppState === 'function') {
            window.AppState = new AppState();
            window.AppState.init();
            console.log('在数据集页面初始化AppState');
        }
        
        loadDatasets()
            .then(() => {
                console.log('数据集加载完成');
            })
            .catch(error => {
                console.error('数据集加载失败:', error);
            });
        
        // 设置表单提交事件
        const datasetUploadForm = document.getElementById('dataset-upload-form');
        if (datasetUploadForm) {
            datasetUploadForm.addEventListener('submit', handleDatasetUpload);
        }
        
        // 设置刷新按钮事件
        const refreshDatasetsBtn = document.getElementById('refresh-datasets-btn');
        if (refreshDatasetsBtn) {
            refreshDatasetsBtn.addEventListener('click', function() {
                loadDatasets(true)
                    .then(() => {
                        showToast('success', '刷新成功', '数据集列表已更新');
                    })
                    .catch(() => {});
            });
        }
        
        // 设置确认删除按钮事件
        const confirmDeleteBtn = document.getElementById('confirm-delete-dataset-btn');
        if (confirmDeleteBtn) {
            confirmDeleteBtn.addEventListener('click', confirmDeleteDataset);
        }
        
        // 设置确认使用数据集按钮事件
        const confirmUseBtn = document.getElementById('confirm-use-dataset-btn');
        if (confirmUseBtn) {
            confirmUseBtn.addEventListener('click', confirmUseDataset);
        }
    });
    
    // 加载数据集列表
    async function loadDatasets(forceReload = false) {
        const datasetsLoading = document.getElementById('datasets-loading');
        const datasetsList = document.getElementById('datasets-list');
        const noDatasetsAlert = document.getElementById('no-datasets');
        const datasetsTableBody = document.getElementById('datasets-table-body');
        
        // 显示加载指示器
        datasetsLoading.classList.remove('d-none');
        datasetsList.classList.add('d-none');
        noDatasetsAlert.classList.add('d-none');
        
        try {
            // 获取数据集列表
            const response = await fetch('/get_datasets');
            
            if (!response.ok) {
                throw new Error('获取数据集列表失败');
            }
            
            const data = await response.json();
            
            // 清空表格
            datasetsTableBody.innerHTML = '';
            
            // 处理数据
            if (data.success && data.datasets && data.datasets.length > 0) {
                // 显示数据集列表
                data.datasets.forEach(dataset => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${dataset.name}</td>
                        <td>${dataset.filename}</td>
                        <td>${dataset.description || '-'}</td>
                        <td>${dataset.total_records}</td>
                        <td>${dataset.spam_count}</td>
                        <td>${dataset.ham_count}</td>
                        <td>${dataset.upload_time}</td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-primary use-dataset-btn" data-dataset-id="${dataset.id}" data-dataset-name="${dataset.name}">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button type="button" class="btn btn-danger delete-dataset-btn" data-dataset-id="${dataset.id}" data-dataset-name="${dataset.name}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    datasetsTableBody.appendChild(row);
                });
                
                // 添加删除和使用按钮事件
                document.querySelectorAll('.delete-dataset-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const datasetId = this.dataset.datasetId;
                        const datasetName = this.dataset.datasetName;
                        showDeleteConfirmation(datasetId, datasetName);
                    });
                });
                
                document.querySelectorAll('.use-dataset-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const datasetId = this.dataset.datasetId;
                        const datasetName = this.dataset.datasetName;
                        showUseDatasetModal(datasetId, datasetName);
                    });
                });
                
                datasetsList.classList.remove('d-none');
            } else {
                // 显示无数据集提示
                noDatasetsAlert.classList.remove('d-none');
            }
        } catch (error) {
            console.error('加载数据集列表错误:', error);
            
            // 显示错误提示
            datasetsTableBody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center">
                        <div class="alert alert-danger mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            加载数据集列表失败: ${error.message}
                        </div>
                    </td>
                </tr>
            `;
            datasetsList.classList.remove('d-none');
        } finally {
            // 隐藏加载指示器
            datasetsLoading.classList.add('d-none');
        }
    }
    
    // 处理数据集上传
    async function handleDatasetUpload(event) {
        event.preventDefault();
        
        const form = event.target;
        const formData = new FormData(form);
        const uploadBtn = document.getElementById('upload-dataset-btn');
        
        // 检查文件是否选择
        const fileInput = document.getElementById('dataset-file');
        if (fileInput.files.length === 0) {
            showToast('error', '上传失败', '请选择CSV文件');
            return;
        }
        
        // 禁用上传按钮
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>上传中...';
        
        try {
            // 发送请求
            const response = await fetch('/save_dataset', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                // 清空表单
                form.reset();
                
                // 显示成功提示
                showToast('success', '上传成功', '数据集已成功上传');
                
                // 重新加载数据集列表
                loadDatasets(true);
            } else {
                // 显示错误提示
                showToast('error', '上传失败', data.error || '数据集上传失败');
            }
        } catch (error) {
            console.error('上传数据集错误:', error);
            showToast('error', '上传失败', error.message);
        } finally {
            // 恢复上传按钮
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<i class="fas fa-upload me-2"></i>上传数据集';
        }
    }
    
    // 显示删除确认模态框
    function showDeleteConfirmation(datasetId, datasetName) {
        const modal = document.getElementById('delete-dataset-modal');
        const nameElem = document.getElementById('delete-dataset-name');
        const confirmBtn = document.getElementById('confirm-delete-dataset-btn');
        
        nameElem.textContent = datasetName;
        confirmBtn.dataset.datasetId = datasetId;
        
        // 显示模态框
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
    }
    
    // 确认删除数据集
    async function confirmDeleteDataset() {
        const confirmBtn = document.getElementById('confirm-delete-dataset-btn');
        const datasetId = confirmBtn.dataset.datasetId;
        const modal = document.getElementById('delete-dataset-modal');
        const bsModal = bootstrap.Modal.getInstance(modal);
        
        // 禁用按钮
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>删除中...';
        
        try {
            // 发送删除请求
            const response = await fetch(`/delete_dataset/${datasetId}`, {
                method: 'DELETE'
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                // 关闭模态框
                bsModal.hide();
                
                // 显示成功提示
                showToast('success', '删除成功', '数据集已成功删除');
                
                // 重新加载数据集列表
                loadDatasets(true);
            } else {
                // 显示错误提示
                showToast('error', '删除失败', data.error || '删除数据集失败');
            }
        } catch (error) {
            console.error('删除数据集错误:', error);
            showToast('error', '删除失败', error.message);
        } finally {
            // 恢复按钮
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '删除';
        }
    }
    
    // 显示使用数据集模态框
    function showUseDatasetModal(datasetId, datasetName) {
        const modal = document.getElementById('use-dataset-modal');
        const titleElem = document.getElementById('useDatasetModalLabel');
        const idInput = document.getElementById('use-dataset-id');
        
        titleElem.textContent = `使用数据集: ${datasetName}`;
        idInput.value = datasetId;
        
        // 显示模态框
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
    }
    
    // 确认使用数据集
    async function confirmUseDataset() {
        const form = document.getElementById('use-dataset-form');
        const formData = new FormData(form);
        const datasetId = formData.get('dataset_id');
        const action = formData.get('action');
        const modelType = formData.get('model_type');
        
        const confirmBtn = document.getElementById('confirm-use-dataset-btn');
        const modal = document.getElementById('use-dataset-modal');
        const bsModal = bootstrap.Modal.getInstance(modal);
        
        // 验证表单
        if (!modelType) {
            showToast('warning', '请选择模型', '请选择要使用的模型类型');
            return;
        }
        
        // 禁用按钮
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>处理中...';
        
        try {
            // 发送请求
            const response = await fetch(`/use_dataset/${datasetId}`, {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                // 关闭模态框
                bsModal.hide();
                
                // 显示成功提示
                showToast('success', '操作成功', data.message || '数据集操作成功');
                
                // 如果是训练操作，可能需要重新加载模型列表
                if (action === 'train') {
                    // 这里可以添加刷新模型列表的代码
                }
            } else {
                // 显示错误提示
                showToast('error', '操作失败', data.error || '使用数据集失败');
            }
        } catch (error) {
            console.error('使用数据集错误:', error);
            showToast('error', '操作失败', error.message);
        } finally {
            // 恢复按钮
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '确认';
        }
    }
    
    // 显示提示消息
    function showToast(type, title, message) {
        // 检查是否存在全局showToast函数
        if (typeof window.showToast === 'function') {
            window.showToast(type, title, message);
            return;
        }
        
        // 如果没有全局函数，创建一个简单的提示
        const toastContainer = document.querySelector('.toast-container');
        
        if (!toastContainer) {
            // 创建容器
            const container = document.createElement('div');
            container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(container);
        }
        
        // 创建toast元素
        const toastElement = document.createElement('div');
        toastElement.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type} border-0`;
        toastElement.setAttribute('role', 'alert');
        toastElement.setAttribute('aria-live', 'assertive');
        toastElement.setAttribute('aria-atomic', 'true');
        
        toastElement.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <strong>${title}:</strong> ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        
        document.querySelector('.toast-container').appendChild(toastElement);
        
        // 显示toast
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
        
        // 自动删除元素
        toastElement.addEventListener('hidden.bs.toast', function() {
            this.remove();
        });
    }
</script>
{% endblock %}